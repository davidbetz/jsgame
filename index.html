<!doctype html>
<html lang="en">
<head>
<title>Simple Game</title>
</head>
<script src="./js/jquery-1.11.2.min.js"></script>
<script src="./js/underscore-min.js"></script>
<body>
<script>
$(function() {
    "use strict";
    var $canvas = $('<canvas />');
    $('body').append($canvas);
    var resize = function(initial) {
       $canvas
            .attr('width', window.innerWidth)
            .attr('height', window.innerHeight)
        update(initial);
    };
    $(window).resize(resize);
    window._board = {
        req: 3,
        layout: [
            "**k*****************",
            "*& #^ #            *",
            "*  #  #     #####  *",
            "*  #        #   ]  *",
            "*  ##########   ###*",
            "*    [##[          *",
            "*  #############   *",
            "*         #        *",
            "*         ]        *",
            "******** ***********",
            "*0 #               *",
            "*  #        #####  *",
            "*  ]        #      *",
            "*  ##########   ###*",
            "*  #[              *",
            "*  ############]###*",
            "*      #^[#   #    *",
            "*     ^#    #      *",
            "********************"
        ],
        obj: function(symbol) {
            return _.find(items, function(p) { return p.symbol == symbol; }) || {};
        },
        symbol: function(name) {
            return (_.find(items, function(p) { return p.name == name; }) || {}).symbol;
        },
        updateCell: function(x ,y, name) {
            window._board.layout[y] = window._board._replaceAt(window._board.layout[y], x, name);
        },
        _replaceAt: function(str, index, c) {
            return str.substring(0, index) + c  + str.substring(index + c.length);
        }
    };
    var items = [
        { name: 'border', symbol: '*', color: 'black' },
        { name: 'wall', symbol: '#', color: 'brown' },
        { name: 'open', symbol: ' ', color: 'white' },
        { name: 'door', symbol: ']', color: 'blue' },
        { name: 'goal', symbol: '0', color: 'purple' },
        { name: 'key_label', symbol: 'k', color: 'silver' },
        { name: 'key', symbol: '[', color: 'silver', item: true },
        { name: 'gold', symbol: '^', color: 'gold', item: true },
        { name: 'toon', symbol: '&', color: 'yellow' },
    ];
    window.render = {
        smallFont: '8pt sans-serif',
        normalFont: '20pt sans-serif',
        circle: function(ctx, x, y, color) {
            ctx.beginPath();
            ctx.arc(x + (size / 2), y + (size / 2), size / 2, 0, 2 * Math.PI, false);
            ctx.fillStyle = color;
            ctx.fill();
        },
        rect: function(ctx, x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, size, size);
        },
        text: function(ctx, text, font, x, y, color) {
            ctx.font = font;
            ctx.strokeStyle = color;
            ctx.strokeText(text, x, y);
        },
        draw: function(ctx, x, y, object, s) {
            var X = x * size;
            var Y = y * size;

            if(debug) {
                render.text(ctx, '(' + x + ', ' + y + ')', render.smallFont, X, Y, 'black');
            }
            if(object.symbol == _board.symbol('gold')) {
                render.circle(ctx, X, Y, object.color);
            }
            else if(object.symbol == _board.symbol('key_label')) {
                render.rect(ctx, X, Y, 'black');
                render.text(ctx, toonData.key, render.normalFont, X + 13, Y + size - 10, 'white');
            }
            else if(object.symbol == _board.symbol('toon')) {
                render.rect(ctx, X, Y, object.color);
                render.text(ctx, toonData.gold, render.normalFont, X + 13, Y + size - 10, 'black');
            }
            else if(object.symbol == _board.symbol('goal')) {
                render.rect(ctx, X, Y, object.color);
                render.text(ctx, window._board.req, render.normalFont, X + 13, Y + size - 10, 'white');
            }
            else if(object.symbol == _board.symbol('key')) {
                render.circle(ctx, X, Y, object.color);
            }
            else {
                render.rect(ctx, X, Y, object.color);
            }
        }
    };
    var debug = false;
    var size = 40;
    var complete = false;
    var canvas = $canvas[0]
    var valid = function(x, y) {
        var c = window._board.layout[y][x];
        var found = c.match(/([0-9])+/);
        if(found) {
            return toonData.gold >= toonData.req;
        }
        switch(c) {
            case _board.symbol('border'):
            case _board.symbol('wall'):
                return false;
            case _board.symbol('door'):
                if(toonData['key'] > 0) {
                    toonData['key']--;
                    window._board.updateCell(x, y, _board.symbol('open'));
                    console.log('Door open.');
                    console.log('Keys: ' + toonData['key']);
                    return true;
                }
                return false;
            default:
                return true;
        }
    }
    var handleObject = function(x, y) {
        var o = window._board.obj(window._board.layout[y][x]);
        if(o.item) {
            if(!toonData[o.name]) {
                toonData[o.name] = 0;
            }
            toonData[o.name]++;
            console.log('Inventory: ' + o.name + ' : ' + toonData[o.name]);
            window._board.updateCell(x, y, _board.symbol('open'));
        }
        else {            
            var found = window._board.layout[y][x].match(/([0-9])+/);
            if(found) {
                if(toonData.gold >= toonData.req) {
                    return function() {
                        complete = true;
                        alert('Finished!');
                    };
                }
            }
        }
        return null;
    }
    $(document).keydown(function(e) {
        if(complete) {
            return;
        }
        window._existing = window._board.layout.slice();
        if(e.which == 37 || e.which == 38 || e.which == 39 || e.which == 40) {
            window._board.updateCell(toonData.x, toonData.y, _board.symbol('open'));
        }
        switch(e.which) {
            case 37:
                if(valid(toonData.x - 1, toonData.y)) {
                    toonData.x--;
                }
                break;
            case 38:
                if(valid(toonData.x, toonData.y - 1)) {
                    toonData.y--;
                }
                break;
            case 40:
                if(valid(toonData.x, toonData.y + 1)) {
                    toonData.y++;
                }
                break;
            case 39:
                if(valid(toonData.x + 1, toonData.y)) {
                    toonData.x++;
                }
                break;
            default:
                return;
        }
        var cb = handleObject(toonData.x, toonData.y);
        if(e.which == 37 || e.which == 38 || e.which == 39 || e.which == 40) {
            window._board.updateCell(toonData.x, toonData.y, _board.symbol('toon'));
        }
        if(debug) {
            console.log('(' + toonData.x + ', ' + toonData.y + ')');
        }
        e.preventDefault();
        update();
        if(cb) {
            cb();
        }
    });
    var toonData = { 
        gold: 0, 
        key: 0,
        req: 0,
        init: function(x, y) {
            toonData.x = x;
            toonData.y = y;
        }
    };
    var update = function(initial) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for(var y=0; y < window._board.layout.length; y++) {
            var row = window._board.layout[y];
            for(var x=0; x < row.length; x++) {
                var cell = row[x];
                
                if(cell == _board.symbol('toon') && initial === true) {
                    toonData.init(x, y);
                }

                render.draw(ctx, x, y, window._board.obj(cell));
            }
        }
    };
    resize(true);
});
</script>
</body>
</html>
